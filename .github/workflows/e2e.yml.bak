name: E2E Tests

    # lighthouse_check removed due to YAML compatibility issues in this environment.
    # Consider re-adding a Lighthouse check using a simple `run:` step or a validated action version later.
              echo "Server is up"; break
            name: E2E Tests

            on:
              push:
                branches: [ main, master ]
              pull_request:
                branches: [ main, master ]

            jobs:
              e2e:
                runs-on: ubuntu-latest
                env:
                  CI: true
                  ALLOW_TEST_ENDPOINTS: true
                steps:
                  - name: Checkout repository
                    uses: actions/checkout@v4

                  - name: Setup Node.js
                    uses: actions/setup-node@v4
                    with:
                      node-version: '18'

                  - name: Install server dependencies
                    run: |
                      cd server
                      npm ci

                  - name: Write Firebase service account (if provided)
                    if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON != '' }}
                    run: |
                      echo 'Writing Firebase service account JSON to server/firebase-service-account.json'
                      mkdir -p server
                      echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}" > server/firebase-service-account.json
                      echo "FIREBASE_SERVICE_ACCOUNT_PATH=server/firebase-service-account.json" >> $GITHUB_ENV

                  - name: Start server in background
                    run: |
                      nohup node server/index.js > server.log 2>&1 &
                      echo $! > server.pid

                  - name: Wait for server to be responsive
                    run: |
                      echo "Waiting for server at http://localhost:3000/api/debug/status"
                      name: E2E Tests

                      on:
                        push:
                          branches: [ main, master ]
                        pull_request:
                          branches: [ main, master ]

                      jobs:
                        e2e:
                          runs-on: ubuntu-latest
                          env:
                            CI: true
                            ALLOW_TEST_ENDPOINTS: true
                          steps:
                            - name: Checkout repository
                              uses: actions/checkout@v4

                            - name: Setup Node.js
                              uses: actions/setup-node@v4
                              with:
                                node-version: '18'

                            - name: Install server dependencies
                              run: |
                                cd server
                                npm ci

                            - name: Write Firebase service account (if provided)
                              if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON != '' }}
                              run: |
                                echo 'Writing Firebase service account JSON to server/firebase-service-account.json'
                                mkdir -p server
                                echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}" > server/firebase-service-account.json
                                echo "FIREBASE_SERVICE_ACCOUNT_PATH=server/firebase-service-account.json" >> $GITHUB_ENV

                            - name: Start server in background
                              run: |
                                nohup node server/index.js > server.log 2>&1 &
                                echo $! > server.pid

                            - name: Wait for server to be responsive
                              run: |
                                echo "Waiting for server at http://localhost:3000/api/debug/status"
                                for i in {1..30}; do
                                  if curl -sSf http://localhost:3000/api/debug/status; then
                                    echo "Server is up"; break
                                  fi
                                  echo "Waiting... ($i)"; sleep 2
                                done

                            - name: Install E2E dependencies
                              run: |
                                cd e2e
                                npm ci

                            - name: Install Playwright browsers
                              run: |
                                cd e2e
                                npx playwright install --with-deps

                            - name: Run tests for browsers (bash loop)
                              run: |
                                set -e
                                for b in chromium firefox webkit; do
                                  echo "Running e2e for $b"
                                  (cd e2e && BROWSER=$b npm test) || true
                                done

                            - name: Upload artifacts (server log + screenshots)
                              if: always()
                              uses: actions/upload-artifact@v4
                              with:
                                name: e2e-artifacts
                                path: |
                                  server.log
                                  e2e/failure-chromium.png
                                  e2e/failure-firefox.png
                                  e2e/failure-webkit.png

                            - name: Stop server
                              if: always()
                              run: |
                                if [ -f server.pid ]; then
                                  kill $(cat server.pid) || true
                                fi

                            - name: Post PR comment with artifacts
                              if: ${{ github.event_name == 'pull_request' }}
                              uses: actions/github-script@v6
                              with:
                                script: |
                                  const runUrl = process.env.GITHUB_RUN_ID ? `https://github.com/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}` : '';
                                  const artifactsUrl = runUrl ? `${runUrl}` : '';
                                  const body = `E2E tests completed. Artifacts and logs: ${artifactsUrl}`;
                                  github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.payload.pull_request.number, body });

                        e2e_docker:
                          name: üê≥ E2E Against Docker Image
                          runs-on: ubuntu-latest
                          env:
                            CI: true
                            ALLOW_TEST_ENDPOINTS: true
                          steps:
                            - name: Checkout repository
                              uses: actions/checkout@v4

                            - name: Build and start containers (App + Nginx)
                              run: |
                                docker-compose up --build -d

                            - name: Wait for Nginx/App to be ready
                              run: |
                                echo "Waiting for Nginx/App to be ready on http://localhost"
                                for i in {1..30}; do
                                  if curl -sSf http://localhost/ || curl -sSf http://localhost:80/; then
                                    echo "App is up"; break
                                  fi
                                  echo "Waiting... ($i)"; sleep 2
                                done

                            - name: Install E2E dependencies and run Playwright
                              run: |
                                cd e2e
                                npm ci
                                npx playwright install --with-deps
                                npx playwright test --project=chromium || true

                            - name: Stop and clean up containers
                              if: always()
                              run: docker-compose down

                            - name: Upload Playwright report (on failure)
                              if: failure()
                              uses: actions/upload-artifact@v4
                              with:
                                name: playwright-report-docker
                                path: e2e/playwright-report
    steps:

      - name: Checkout repository
