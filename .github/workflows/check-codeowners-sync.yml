name: Check CODEOWNERS sync

on:
  push:
    paths:
      - '.github/reviewers.json'
      - '.github/CODEOWNERS'
  pull_request:
    paths:
      - '.github/reviewers.json'
      - '.github/CODEOWNERS'

jobs:
  check-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run CODEOWNERS sync check
        id: sync_check
        continue-on-error: true
        run: |
          npm ci --no-audit --no-fund
          node .github/scripts/sync-reviewers.js --check
      - name: Create fix branch and push (PR events only)
        if: ${{ failure() && github.event_name == 'pull_request' }}
        run: |
          set -e
          # branch name using short SHA for idempotence
          BRANCH=auto/codeowners-fix-${GITHUB_SHA::7}
          echo "Creating branch $BRANCH"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          node .github/scripts/sync-reviewers.js --write
          if git status --porcelain | grep -q .; then
            git add .github/CODEOWNERS
            git commit -m "chore(ci): sync CODEOWNERS from reviewers.json"
            git push --set-upstream origin "$BRANCH"
            echo "FIX_BRANCH=$BRANCH" >> $GITHUB_ENV
            # base branch to open PR against
            echo "PR_BASE=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
          else
            echo "No changes to push"
            echo "FIX_BRANCH=" >> $GITHUB_ENV
            echo "PR_BASE=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
          fi

      - name: Create a draft fix PR (if branch created)
        if: ${{ failure() && github.event_name == 'pull_request' && env.FIX_BRANCH != '' }}
        uses: actions/github-script@v7
        id: create_pr
        with:
          script: |
            const branch = process.env.FIX_BRANCH;
            const base = process.env.PR_BASE || context.payload.pull_request.base.ref;
            const title = 'chore(ci): sync CODEOWNERS from reviewers.json';
            const body = 'This PR was created automatically to sync `.github/CODEOWNERS` with `.github/reviewers.json`.';
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: branch,
              base: base,
              title: title,
              body: body,
              draft: true
            });
            core.setOutput('pr_number', pr.data.number);
            core.setOutput('pr_url', pr.data.html_url);
        env:
          FIX_BRANCH: ${{ env.FIX_BRANCH }}
          PR_BASE: ${{ env.PR_BASE }}

      - name: Add reviewers and labels to fix PR
        if: ${{ failure() && github.event_name == 'pull_request' && env.FIX_BRANCH != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER || '${{ steps.create_pr.outputs.pr_number }}', 10);
            // read reviewers.json from the checked-out repo
            const fs = require('fs');
            const path = '.github/reviewers.json';
            let reviewers = [];
            let team_reviewers = [];
            if (fs.existsSync(path)){
              try {
                const j = JSON.parse(fs.readFileSync(path,'utf8'));
                reviewers = j.reviewers || [];
                team_reviewers = j.team_reviewers || [];
              } catch(e){ core.info('failed to parse reviewers.json'); }
            }
            if (reviewers.length > 0 || team_reviewers.length > 0){
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                reviewers: reviewers,
                team_reviewers: team_reviewers
              });
            }
            // add labels
            const labels = ['auto-sync', 'bot'];
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: labels
            });

      - name: Comment on PR when out-of-sync
        if: ${{ failure() && github.event_name == 'pull_request' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ⚠️ The repository's `.github/CODEOWNERS` is out-of-sync with `.github/reviewers.json`.

            I created an automated fix PR you can review: ${{ steps.create_pr.outputs.pr_url }}

            To fix locally instead, run:

            ```bash
            npm ci --no-audit --no-fund
            node .github/scripts/sync-reviewers.js --write
            git add .github/CODEOWNERS
            git commit -m "chore: sync CODEOWNERS from reviewers.json"
            git push
            ```

            Alternatively, update `.github/reviewers.json` appropriately and open a PR.

      - name: Fail if out-of-sync
        if: ${{ failure() }}
        run: |
          echo "CODEOWNERS is out-of-sync with reviewers.json" >&2
          exit 1
