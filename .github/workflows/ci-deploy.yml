name: CI - Tests & CodeQL & Build (fixed)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  NODE_ENV: test

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (server)
        run: |
          cd server
          npm ci

      - name: Run server unit tests
        run: |
          cd server
          npm test

  codeql:
    name: CodeQL Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript
      - name: Perform CodeQL Scan
        uses: github/codeql-action/analyze@v2

  build:
    name: Build Docker image
    runs-on: ubuntu-latest
    needs: [ test ]
    steps:
      - uses: actions/checkout@v4
      - name: Build docker image
        run: |
          docker build -t futebol-analytics:ci .

  optional_scans:
    name: Optional Scans (Trivy / Snyk)
    runs-on: ubuntu-latest
    needs: [ build ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy if available
        run: |
          if command -v trivy >/dev/null 2>&1; then
            trivy image --severity HIGH,CRITICAL futebol-analytics:ci || true
          else
            echo "Trivy not installed in runner; skipping image scan"
          fi

      - name: Run Snyk (if SNYK_TOKEN provided)
        if: ${{ secrets.SNYK_TOKEN != '' }}
        run: |
          echo "Snyk token provided; attempting snyk test (best-effort)"
          npm i -g snyk || true
          snyk auth ${{ secrets.SNYK_TOKEN }} || true
          snyk test || true
