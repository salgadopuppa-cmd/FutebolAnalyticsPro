#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const repoRoot = path.resolve(__dirname, '..', '..');
const reviewersPath = path.join(repoRoot, '.github', 'reviewers.json');
const codeownersPath = path.join(repoRoot, '.github', 'CODEOWNERS');

function prefixOwner(entry){
  if (!entry) return null;
  if (entry.startsWith('@')) return entry;
  if (entry.includes('/')) return '@' + entry;
  return '@' + entry;
}

function buildCodeowners(reviewers, team_reviewers){
  const owners = [];
  (reviewers || []).forEach(r => { const p = prefixOwner(r); if(p) owners.push(p); });
  (team_reviewers || []).forEach(t => { const p = prefixOwner(t); if(p) owners.push(p); });

  const header = `# CODEOWNERS (generated)\n# This file is generated from .github/reviewers.json by .github/scripts/sync-reviewers.js\n# Do not edit this file directly; edit .github/reviewers.json instead and run the script or open a PR.\n\n`;

  const ownersLine = owners.length ? owners.join(' ') : '';
  const lines = [
    header,
    `# Owners for everything in the repo`,
    owners.length ? `* ${ownersLine}` : '*',
    '',
    `# Owners for server code`,
    owners.length ? `server/* ${ownersLine}` : 'server/*',
    '',
  ];
  return lines.join('\n');
}

function readJSON(p){
  if (!fs.existsSync(p)) return {};
  try { return JSON.parse(fs.readFileSync(p,'utf8')); } catch(e){
    console.error('Failed to parse', p, e.message);
    process.exit(2);
  }
}

function main(){
  const argv = process.argv.slice(2);
  const shouldWrite = argv.includes('--write');
  const shouldCheck = argv.includes('--check');

  const j = readJSON(reviewersPath);
  const content = buildCodeowners(j.reviewers || [], j.team_reviewers || []);

  if (!fs.existsSync(codeownersPath)){
    if (shouldCheck){
      console.error('.github/CODEOWNERS missing');
      process.exit(1);
    }
  }

  if (shouldCheck){
    const existing = fs.existsSync(codeownersPath) ? fs.readFileSync(codeownersPath,'utf8') : '';
    if (existing.trim() !== content.trim()){
      console.error('CODEOWNERS is out of sync with reviewers.json');
      process.exit(1);
    }
    console.log('CODEOWNERS is up-to-date');
    process.exit(0);
  }

  if (shouldWrite){
    fs.writeFileSync(codeownersPath, content + '\n', 'utf8');
    console.log('Wrote .github/CODEOWNERS');
    process.exit(0);
  }

  // default: print the generated content
  console.log(content);
}

main();
